# Dockerfile Fix

[![Build status](https://badge.buildkite.com/03d74a65e7c0c16a3ef6e9ec6bf6e7a8e249f12625f6f1f525.svg)](https://buildkite.com/personal-70/tech-test-1)

This API provides a single Information:
  - Hello World! 

## Changes made

- No issue on docker build process was found. According to Michael, this was fixed on the base image, and because the Dockefile was using the latest, it also fixed this app issue.
- App was not working properly. It was binding the address 127.0.0.1, but changing to 0.0.0.0 fixed the issue and App is successfully showing the **Hello world** message as expected.
- Changed the dockerfile to use a specific golang docker image as base, which will avoid any changes to the latest to impact this app build process.
- Created two stages in the dockerfile. First one build and test the application and second is just using the artefact generated by the build in the final image. As a resut, the image won't have as many unnecessary packages and had its size reduced in 60Mb.
- Additionally, the multistage is configured in a way to reuse  most of the layers created on the first stage in the final stage.

## Pipeline

A Buildkite pipeline is being used to build, test and publish this container through the scripts stored on the scripts folder of this repository. The pipeline stages are defined on the **pipeline.yaml** file on the **.buildkite** folder of this repository.

### Agent pre requisites
The buildkite agent have the following pre-requisites:
- Docker
- GIT Repository credentias(if used with a private instance of github or with a private repository)
- Docker image repository(ECR/Artifactory/etc) credential token so the image can be successfully published

### Build
The build is created by using the multi-stage **Dockerfile** file stored in the root folder of this repository and it contains two stages. The first stage build the application and run some unit tests.

### Publish
The image is tagged with the proper values and is published on the docker image repository defined in the **publish.sh** script.


## Running this container locally
This application can run locally on machines with the following pre-requisites:
- Docker
- GIT Repository Credentials (if used with a private instance of github or with a private repository)

### Steps to run this locally
In order to run this application locally, the container image will need to be created. To create it, run the following command from this repository root folder:
```
./scripts/build.sh
```
Once the build is completed, you can run the container with the following command:
```
./scripts/localrun.sh
```

After having the container into a running state, you can access the API with a **http://localhost:8000** and should receive the **Hello World** message.

## Running this pipelne on a different CI tool
This pipeline can be easily migrated to different CI tools but adjustments may be required. CI tools with instances agents can be easily used. Since the stages are using bash scripts, those can be easily leveraged to different CI tools and the only change would be the pipeline instructions file to be created based on the new tool.
For containerized CI tools, additional changes will be required, since most of the bash scripts will not be able to be used, however the same steps can be easily migrated to tools like TravisCI and Drone.IO.




